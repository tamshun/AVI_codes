# 汎用的な Staff-Customer 会話練習システム

AutoGen + Anthropic/Gemini を使用した、スタッフとカスタマー間の会話をシミュレーションし、評価するシステムです。

## 🎯 概要

このシステムは、以下の機能を提供します：

- **顧客・スタッフロールプレイ**: AIエージェントが顧客とスタッフの役割を演じる
- **自動評価**: 会話品質とペルソナ一貫性を自動評価
- **マルチLLM対応**: Anthropic Claude と Google Gemini に対応
- **詳細ログ**: 会話内容とシステムログを自動保存
- **自然な会話終了**: DONEキーワードによる適切な会話終了

## 📋 必要なファイル

プロジェクトルートに以下のファイルが必要です：

### 必須ファイル
- `customer_persona.md` - 顧客ペルソナの定義（テスト対象のLLM設定）
- `staff_persona.md` - スタッフペルソナの定義
- `evaluator_prompt.md` - 評価エージェント用プロンプト
- `.env` - API認証情報

### 自動生成ファイル
- `logs/` ディレクトリ - システムログと会話ログが保存される

## 🚀 セットアップ

### 1. 必要なライブラリのインストール

```bash
pip install python-dotenv autogen-core 'autogen-agentchat>=0.2.20' 'autogen-ext[anthropic]' 'autogen-ext[openai]'
```

### 2. 環境変数の設定

`.env` ファイルを作成し、使用するAPIプロバイダーに応じて設定：

#### Anthropic Claude を使用する場合:
```env
API_PROVIDER=anthropic
ANTHROPIC_API_KEY=your_anthropic_api_key_here
ANTHROPIC_CUSTOMER_MODEL=claude-3-haiku-20240307
ANTHROPIC_STAFF_MODEL=claude-3-5-sonnet-20240620
```

#### Google Gemini を使用する場合:
```env
API_PROVIDER=gemini
GOOGLE_API_KEY=your_google_api_key_here
GEMINI_CUSTOMER_MODEL=gemini-1.5-flash-latest
GEMINI_STAFF_MODEL=gemini-1.5-flash-latest
GEMINI_API_BASE_URL=https://generativelanguage.googleapis.com/v1beta
```

### 3. ペルソナファイルの作成

#### `customer_persona.md` の例:
```markdown
# 顧客ペルソナ

あなたは困っているお客様です。
- 年齢: 30代
- 性格: 少し不安になりやすい
- 状況: 商品の使い方がわからず困っている
- 話し方: 丁寧だが、少し焦りがち

## 行動指針
- 具体的な質問をする
- 解決策が見つかったら感謝を示す
- 不明な点は遠慮なく聞く
```

#### `staff_persona.md` の例:
```markdown
# スタッフペルソナ

あなたは親切なカスタマーサポートスタッフです。
- 経験年数: 3年
- 性格: 親しみやすく、解決志向
- 専門分野: 商品サポート全般
- 話し方: 丁寧で分かりやすい説明を心がける

## 行動指針
- お客様の問題を正確に把握する
- 段階的で分かりやすい解決策を提示
- 最後まで責任を持ってサポート
```

#### `evaluator_prompt.md` の例:
```markdown
# 会話評価プロンプト

以下の観点から会話を評価してください：

## 評価項目
1. **ペルソナ一貫性** (1-5点)
   - 各エージェントが設定されたペルソナを維持できているか

2. **会話の自然さ** (1-5点)
   - 会話の流れが自然で適切か

3. **問題解決効果** (1-5点)
   - 顧客の問題が適切に解決されたか

4. **コミュニケーション品質** (1-5点)
   - 明確で理解しやすいコミュニケーションか

## 出力形式
各項目の点数と改善点を具体的に記述してください。
```

## 💻 使用方法

### 基本的な実行

```bash
python auto_debugging.py
```

実行すると以下の入力が求められます：

1. **シナリオ**: 会話のシチュエーション（例：「商品の返品相談」）
2. **初期メッセージ**: 会話の最初のメッセージ（例：「すみません、商品について質問があります」）

### 実行例

```
🔧 システム初期化中...
✅ 初期化完了 (ログ・API設定)
✅ 全プロンプトファイル読み込み完了

📋 会話テストの設定
----------------------------------------
シナリオを入力してください（空白でデフォルト「一般的なカスタマーサポート」）: 商品の使い方相談
最初のメッセージを入力してください（空白でデフォルト「こんにちは」）: 購入した商品の設定方法がわかりません

🎭 テスト設定:
  シナリオ: 商品の使い方相談
  初期メッセージ: 購入した商品の設定方法がわかりません
  最大ターン数: 100
```

## 📊 出力と結果

### 会話ログ
- **JSON形式**: `logs/chat_YYYYMMDD_HHMMSS.json`
- **システムログ**: `logs/conversation_YYYYMMDD_HHMMSS.log`

### 出力例
```
📜 会話履歴:
========================================

[Customer]: 購入した商品の設定方法がわかりません
----------------------------------------

[Staff]: ご購入ありがとうございます。どちらの商品の設定でお困りでしょうか？商品名を教えていただけますか？
----------------------------------------

[Customer]: スマートスピーカーのABC-123という商品です
----------------------------------------

[Staff]: ABC-123ですね。まず電源ケーブルを接続して、本体の電源ボタンを3秒間長押ししてください。青いライトが点灯しましたか？
----------------------------------------

[Customer]: はい、青いライトが点灯しました！
----------------------------------------

[Staff]: 素晴らしいです！次にスマートフォンのアプリから設定を行います。アプリはダウンロード済みでしょうか？
----------------------------------------

[Customer]: はい、ダウンロードしています
----------------------------------------

[Staff]: それでは、アプリを開いて「新しいデバイスを追加」をタップしてください。その後、画面の指示に従って進めていただけますか？
----------------------------------------

[Customer]: 設定できました！ありがとうございました。DONE
----------------------------------------

[Staff]: お役に立てて良かったです。他にご質問がございましたら、いつでもお声かけください。DONE
----------------------------------------

📝 評価結果
================================================================================
## 会話評価

### 1. ペルソナ一貫性: 5/5点
- Customer: 困っている顧客として一貫した行動
- Staff: 親切で段階的なサポートを提供

### 2. 会話の自然さ: 5/5点
- スムーズな質疑応答の流れ
- 適切なタイミングでの会話終了

### 3. 問題解決効果: 5/5点
- 顧客の問題が段階的に解決
- 明確な解決確認

### 4. コミュニケーション品質: 5/5点
- 分かりやすい説明
- 適切な確認とフォロー
================================================================================
```

## ⚙️ カスタマイズ

### モデル設定の変更

環境変数でモデルを変更できます：

```env
# より高性能なモデルを使用
ANTHROPIC_CUSTOMER_MODEL=claude-3-5-sonnet-20240620
ANTHROPIC_STAFF_MODEL=claude-3-opus-20240229

# Geminiの場合
GEMINI_CUSTOMER_MODEL=gemini-1.5-pro-latest
GEMINI_STAFF_MODEL=gemini-1.5-pro-latest
```

### 最大ターン数の調整

コード内の `max_turns=100` を変更することで、会話の最大長を調整できます。

## 🔧 トラブルシューティング

### よくあるエラー

1. **APIキーエラー**
   ```
   ValueError: ANTHROPIC_API_KEY環境変数が設定されていません。
   ```
   → `.env` ファイルでAPIキーを正しく設定してください

2. **ライブラリインポートエラー**
   ```
   ImportError: 必要なパッケージがインストールされていません
   ```
   → 必要なライブラリを再インストールしてください

3. **ファイルが見つからないエラー**
   ```
   FileNotFoundError: 顧客ペルソナファイルが見つかりません
   ```
   → 必須ファイル（`customer_persona.md` など）を作成してください

### ログの確認

詳細なエラー情報は `logs/` ディレクトリのログファイルで確認できます。

## 📈 活用例

- **カスタマーサポート研修**: 新人スタッフの対応練習
- **チャットボット開発**: 会話フローの検証
- **LLMペルソナテスト**: 異なるペルソナ設定の比較評価
- **会話品質改善**: 対応パターンの分析と改善

## 🤝 貢献

バグ報告や機能要望がありましたら、プロジェクトのIssueでお知らせください。

## 📄 ライセンス

このプロジェクトは適切なライセンスのもとで公開されています。詳細はLICENSEファイルを参照してください。